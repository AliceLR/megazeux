##
# MegaZeux Network Makefile fragment
##

.PHONY: network network_clean

network_base = src/network

updater := ${network_base}/updater${BINEXT}
updater_objs := ${mzx_base}/util.o
updater_objs += ${network_base}/host.o ${network_base}/manifest.o
updater_objs += ${network_base}/sha256.o ${network_base}/updater.o
updater_ldflags := -L${PREFIX}/lib -lz

ifeq (${PLATFORM},mingw)
updater_ldflags += ${SDL_LDFLAGS}
endif

server := ${network_base}/server${BINEXT}
server_objs := ${mzx_base}/util.o
server_objs += ${network_base}/host.o ${network_base}/manifest.o
server_objs += ${network_base}/sha256.o ${network_base}/server.o
server_ldflags := ${SDL_LDFLAGS} -L${PREFIX}/lib -lz

-include ${updater_objs:.o=.d}
-include ${server_objs:.o=.d}

network: ${updater} ${server}

${updater}: ${updater_objs}
ifeq (${V},1)
	${HOST_CC} ${updater_objs} \
	        -o ${updater} ${LDFLAGS} ${updater_ldflags}
else
	@echo "  LINK    " ${updater}
	@${HOST_CC} ${updater_objs} \
	         -o ${updater} ${LDFLAGS} ${updater_ldflags}
endif
ifneq (${DEBUG},1)
ifeq (${V},1)
	${STRIP} ${updater}
else
	@echo "  STRIP   " ${updater}
	@${STRIP} ${updater}
endif
endif

${server}: ${server_objs}
ifeq (${V},1)
	${HOST_CC} ${server_objs} \
	        -o ${server} ${LDFLAGS} ${server_ldflags}
else
	@echo "  LINK    " ${server}
	@${HOST_CC} ${server_objs} \
	         -o ${server} ${LDFLAGS} ${server_ldflags}
endif
ifneq (${DEBUG},1)
ifeq (${V},1)
	${STRIP} ${server}
else
	@echo "  STRIP   " ${server}
	@${STRIP} ${server}
endif
endif

network_clean: ${updater}_clean ${server}_clean

${updater}_clean:
	@echo "  CLEAN   " ${updater}
	@rm -f ${updater_objs} ${updater} ${updater_objs:.o=.d}

${server}_clean:
	@echo "  CLEAN   " ${server}
	@rm -f ${server_objs} ${server} ${server_objs:.o=.d}
