##
# MegaZeux Utils Makefile fragment
##

include contrib/unzip/src/Makefile.in

#
# FIXME: This whole file is a giant wart on the new build system
#        and needs some love (and refactoring) to fix it
#

.PHONY: utils utils_clean utils_package_clean

utils_src = src/utils
utils_obj  = src/utils/.build

checkres := ${utils_src}/checkres${BINEXT}
checkres_objs := src/.build/fsafeopen.o src/.build/util.o
checkres_objs += ${utils_obj}/checkres.o ${unzip_objs}
checkres_ldflags := -L${PREFIX}/lib -lz

downver := ${utils_src}/downver${BINEXT}
downver_objs := ${utils_obj}/downver.o

hlp2txt := ${utils_src}/hlp2txt${BINEXT}
hlp2txt_objs := ${utils_obj}/hlp2txt.o

txt2hlp := ${utils_src}/txt2hlp${BINEXT}
txt2hlp_objs := ${utils_obj}/txt2hlp.o

${utils_obj}/%.o: ${utils_src}/%.c
	$(if ${V},,@echo "  HOST_CC " $<)
	${HOST_CC} -MD ${CFLAGS} -I${mzx_src} -I${unzip_src} \
	                         -I${PREFIX}/include -c $< -o $@

-include $(checkres_objs:.o=.d)
-include $(downver_objs:.o=.d)
-include $(hlp2txt_objs:.o=.d)
-include $(txt2hlp_objs:.o=.d)

ifeq (${BUILD_UTILS},1)

${checkres}: ${checkres_objs}
	$(if ${V},,@echo "  LINK    " ${checkres})
	${HOST_CC} ${checkres_objs} \
	        -o ${checkres} ${LDFLAGS} ${checkres_ldflags}
ifneq (${DEBUG},1)
	$(if ${V},,@echo "  STRIP   " ${checkres})
	${STRIP} ${checkres}
endif

${downver}: ${downver_objs}
	$(if ${V},,@echo "  LINK    " ${downver})
	${HOST_CC} ${downver_objs} -o ${downver} ${LDFLAGS}
ifneq (${DEBUG},1)
	$(if ${V},,@echo "  STRIP   " ${downver})
	${STRIP} ${downver}
endif

${hlp2txt}: ${hlp2txt_objs}
	$(if ${V},,@echo "  LINK    " ${hlp2txt})
	${HOST_CC} ${hlp2txt_objs} -o ${hlp2txt} ${LDFLAGS}
ifneq (${DEBUG},1)
	$(if ${V},,@echo "  STRIP   " ${hlp2txt})
	${STRIP} ${hlp2txt}
endif

${txt2hlp}: ${txt2hlp_objs}
	$(if ${V},,@echo "  LINK    " ${txt2hlp})
	${HOST_CC} ${txt2hlp_objs} -o ${txt2hlp} ${LDFLAGS}
ifneq (${DEBUG},1)
	$(if ${V},,@echo "  STRIP   " ${txt2hlp})
	${STRIP} ${txt2hlp}
endif

utils_package_clean:
	@mv ${checkres} ${checkres}.backup
	@mv ${downver} ${downver}.backup
	@mv ${hlp2txt} ${hlp2txt}.backup
	@mv ${txt2hlp} ${txt2hlp}.backup
	@${MAKE} utils_clean
	@mv ${txt2hlp}.backup ${txt2hlp}
	@mv ${hlp2txt}.backup ${hlp2txt}
	@mv ${downver}.backup ${downver}
	@mv ${checkres}.backup ${checkres}

utils: $(filter-out $(wildcard ${utils_obj}), ${utils_obj})
utils: ${checkres} ${downver} ${hlp2txt} ${txt2hlp}

else

utils_package_clean:

utils:
	@echo "--> Building of utilities disabled."

endif

utils_clean: unzip_clean
	$(if ${V},,@echo "  RM      " ${utils_obj})
	${RM} -r ${utils_obj}
	$(if ${V},,@echo "  RM      " ${checkres} ${downver})
	$(if ${V},,@echo "  RM      " ${hlp2txt} ${txt2hlp})
	${RM} ${checkres} ${downver} ${hlp2txt} ${txt2hlp}
