##
# MegaZeux Utils Makefile fragment
##

include contrib/unzip/src/Makefile.in

#
# FIXME: This whole file is a giant wart on the new build system
#        and needs some love (and refactoring) to fix it
#

.PHONY: ${checkres}_clean ${downver}_clean ${hlp2txt}_clean ${txt2hlp}_clean
.PHONY: utils utils_clean utils_package_clean

utils_base = src/utils

checkres := ${utils_base}/checkres${BINEXT}
checkres_objs := src/.build/fsafeopen.o src/.build/util.o
checkres_objs += ${utils_base}/checkres.o ${unzip_objs}
checkres_ldflags := -L${PREFIX}/lib -lz

downver := ${utils_base}/downver${BINEXT}
downver_objs := ${utils_base}/downver.o

hlp2txt := ${utils_base}/hlp2txt${BINEXT}
hlp2txt_objs := ${utils_base}/hlp2txt.o

txt2hlp := ${utils_base}/txt2hlp${BINEXT}
txt2hlp_objs := ${utils_base}/txt2hlp.o

${utils_base}/%.o: ${utils_base}/%.c
ifneq (${V},1)
	@echo "  HOST_CC " $<
endif
	${HOST_CC} -MD ${CFLAGS} -I${mzx_src} -I${unzip_src} \
	                         -I${PREFIX}/include -c $< -o $@

-include $(checkres_objs:.o=.d)
-include $(downver_objs:.o=.d)
-include $(hlp2txt_objs:.o=.d)
-include $(txt2hlp_objs:.o=.d)

ifeq (${BUILD_UTILS},1)

${checkres}: ${checkres_objs}
ifneq (${V},1)
	@echo "  LINK    " ${checkres}
endif
	${HOST_CC} ${checkres_objs} \
	        -o ${checkres} ${LDFLAGS} ${checkres_ldflags}
ifneq (${DEBUG},1)
ifneq (${V},1)
	@echo "  STRIP   " ${checkres}
endif
	${STRIP} ${checkres}
endif

${downver}: ${downver_objs}
ifneq (${V},1)
	@echo "  LINK    " ${downver}
endif
	${HOST_CC} ${downver_objs} -o ${downver} ${LDFLAGS}
ifneq (${DEBUG},1)
ifneq (${V},1)
	@echo "  STRIP   " ${downver}
endif
	${STRIP} ${downver}
endif

${hlp2txt}: ${hlp2txt_objs}
ifneq (${V},1)
	@echo "  LINK    " ${hlp2txt}
endif
	${HOST_CC} ${hlp2txt_objs} -o ${hlp2txt} ${LDFLAGS}
ifneq (${DEBUG},1)
ifneq (${V},1)
	@echo "  STRIP   " ${hlp2txt}
endif
	${STRIP} ${hlp2txt}
endif

${txt2hlp}: ${txt2hlp_objs}
ifneq (${V},1)
	@echo "  LINK    " ${txt2hlp}
endif
	${HOST_CC} ${txt2hlp_objs} -o ${txt2hlp} ${LDFLAGS}
ifneq (${DEBUG},1)
ifneq (${V},1)
	@echo "  STRIP   " ${txt2hlp}
endif
	${STRIP} ${txt2hlp}
endif

utils_package_clean:
	@mv ${checkres} ${checkres}.backup
	@mv ${downver} ${downver}.backup
	@mv ${hlp2txt} ${hlp2txt}.backup
	@mv ${txt2hlp} ${txt2hlp}.backup
	@${MAKE} DEBUG=1 utils_clean
	@${MAKE}         utils_clean
	@mv ${txt2hlp}.backup ${txt2hlp}
	@mv ${hlp2txt}.backup ${hlp2txt}
	@mv ${downver}.backup ${downver}
	@mv ${checkres}.backup ${checkres}

else

${checkres}:
	@echo "--> Building of checkres disabled."
${downver}:
	@echo "--> Building of downver disabled."
${hlp2txt}:
	@echo "--> Building of hlp2txt disabled."
${txt2hlp}:
	@echo "--> Building of txt2hlp disabled."
utils_package_clean:

endif

utils: ${checkres} ${downver} ${hlp2txt} ${txt2hlp}

utils_clean: ${checkres}_clean ${downver}_clean
utils_clean: ${hlp2txt}_clean ${txt2hlp}_clean

${checkres}_clean: unzip_clean
	@echo "  CLEAN   " ${checkres}
	@rm -f ${checkres_objs} ${checkres} $(checkres_objs:.o=.d)

${downver}_clean:
	@echo "  CLEAN   " ${downver}
	@rm -f ${downver_objs} ${downver} $(downver_objs:.o=.d)

${hlp2txt}_clean:
	@echo "  CLEAN   " ${hlp2txt}
	@rm -f ${hlp2txt_objs} ${hlp2txt} $(hlp2txt_objs:.o=.d)

${txt2hlp}_clean:
	@echo "  CLEAN   " ${txt2hlp}
	@rm -f ${txt2hlp_objs} ${txt2hlp} $(txt2hlp_objs:.o=.d)
