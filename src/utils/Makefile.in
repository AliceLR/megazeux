##
# MegaZeux Utils Makefile fragment
##

include contrib/unzip/src/Makefile.in

#
# FIXME: This whole file is a giant wart on the new build system
#        and needs some love (and refactoring) to fix it
#

.PHONY: utils utils.debug utils_clean utils_package_clean

CFLAGS += -fno-stack-protector

utils_src = src/utils
utils_obj = src/utils/.build

checkres := ${utils_src}/checkres${BINEXT}
checkres_objs := ${utils_obj}/checkres.o ${core_obj}/fsafeopen.o
checkres_objs += ${core_obj}/util.o ${unzip_objs}
checkres_ldflags := ${ZLIB_LDFLAGS}

downver := ${utils_src}/downver${BINEXT}
downver_objs := ${utils_obj}/downver.o

hlp2txt := ${utils_src}/hlp2txt${BINEXT}
hlp2txt_objs := ${utils_obj}/hlp2txt.o

txt2hlp := ${utils_src}/txt2hlp${BINEXT}
txt2hlp_objs := ${utils_obj}/txt2hlp.o

${utils_obj}/%.o: ${utils_src}/%.c
	$(if ${V},,@echo "  CC      " $<)
	${CC} -MD ${CFLAGS} -I${core_src} -I${unzip_src} ${ZLIB_CFLAGS} -c $< -o $@

-include $(checkres_objs:.o=.d)
-include $(downver_objs:.o=.d)
-include $(hlp2txt_objs:.o=.d)
-include $(txt2hlp_objs:.o=.d)

${checkres}: ${checkres_objs} ${core_target}
	$(if ${V},,@echo "  LINK    " ${checkres})
	${CC} ${checkres_objs} -o ${checkres} ${LDFLAGS} ${checkres_ldflags}

${downver}: ${downver_objs}
	$(if ${V},,@echo "  LINK    " ${downver})
	${CC} ${downver_objs} -o ${downver} ${LDFLAGS}

${hlp2txt}: ${hlp2txt_objs}
	$(if ${V},,@echo "  LINK    " ${hlp2txt})
	${CC} ${hlp2txt_objs} -o ${hlp2txt} ${LDFLAGS}

${txt2hlp}: ${txt2hlp_objs}
	$(if ${V},,@echo "  LINK    " ${txt2hlp})
	${CC} ${txt2hlp_objs} -o ${txt2hlp} ${LDFLAGS}

utils: $(filter-out $(wildcard ${utils_obj}), ${utils_obj})

utils: ${checkres} ${downver} ${hlp2txt} ${txt2hlp}
utils.debug: ${checkres}.debug ${downver}.debug
utils.debug: ${hlp2txt}.debug ${txt2hlp}.debug

utils_clean: unzip_clean
	$(if ${V},,@echo "  RM      " ${utils_obj})
	${RM} -r ${utils_obj}
	$(if ${V},,@echo "  RM      " ${checkres} ${checkres}.debug)
	${RM} ${checkres} ${checkres}.debug
	$(if ${V},,@echo "  RM      " ${downver} ${downver}.debug)
	${RM} ${downver} ${downver}.debug
	$(if ${V},,@echo "  RM      " ${hlp2txt} ${hlp2txt}.debug)
	${RM} ${hlp2txt} ${hlp2txt}.debug
	$(if ${V},,@echo "  RM      " ${txt2hlp} ${txt2hlp}.debug)
	${RM} ${txt2hlp} ${txt2hlp}.debug

utils_package_clean:
	-@mv ${checkres}       ${checkres}.backup
	-@mv ${checkres}.debug ${checkres}.debug.backup
	-@mv ${downver}        ${downver}.backup
	-@mv ${downver}.debug  ${downver}.debug.backup
	-@mv ${hlp2txt}        ${hlp2txt}.backup
	-@mv ${hlp2txt}.debug  ${hlp2txt}.debug.backup
	-@mv ${txt2hlp}        ${txt2hlp}.backup
	-@mv ${txt2hlp}.debug  ${txt2hlp}.debug.backup
	@${MAKE} utils_clean
	-@mv ${checkres}.backup       ${checkres}
	-@mv ${checkres}.debug.backup ${checkres}.debug
	-@mv ${downver}.backup        ${downver}
	-@mv ${downver}.debug.backup  ${downver}.debug
	-@mv ${hlp2txt}.backup        ${hlp2txt}
	-@mv ${hlp2txt}.debug.backup  ${hlp2txt}.debug
	-@mv ${txt2hlp}.backup        ${txt2hlp}
	-@mv ${txt2hlp}.debug.backup  ${txt2hlp}.debug
