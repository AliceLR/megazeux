#
# OS X makefile generics
#

STRIP   ?= strip

ifeq (${ARCH},)
ARCH := i686
endif

ifeq (${ARCH},i686)
CC        := i686-apple-darwin9-gcc-4.0.1 -mmacosx-version-min=10.3
CXX       := i686-apple-darwin9-g++-4.0.1 -mmacosx-version-min=10.3
REAL_ARCH := i686
else ifeq (${ARCH},amd64)
CC        := i686-apple-darwin9-gcc-4.0.1 -m64 -mmacosx-version-min=10.5
CXX       := i686-apple-darwin9-g++-4.0.1 -m64 -mmacosx-version-min=10.5
REAL_ARCH := amd64
else ifeq (${ARCH},ppc)
CC        := powerpc-apple-darwin9-gcc-4.0.1 -mmacosx-version-min=10.3
CXX       := powerpc-apple-darwin9-g++-4.0.1 -mmacosx-version-min=10.3
REAL_ARCH := ppc
else ifeq (${ARCH},ppc64)
CC        := powerpc-apple-darwin9-gcc-4.0.1 -m64 -mmacosx-version-min=10.4
CXX       := powerpc-apple-darwin9-g++-4.0.1 -m64 -mmacosx-version-min=10.4
REAL_ARCH := ppc64
else
REAL_ARCH := $(error Invalid architecture selection)
endif

DSOLDFLAGS = -dynamiclib
DSOPRE     = lib
DSOPOST    = .dylib
DSORPATH   =
DSOSONAME  = -install_name @executable_path/

SDL_CFLAGS  = -I${PREFIX}/SDL.Framework/Headers
SDL_LDFLAGS = -framework SDL

LIBPNG_CFLAGS  = -I${PREFIX}/libpng.Framework/Headers
LIBPNG_LDFLAGS = -framework libpng

VORBIS_CFLAGS  = -I${PREFIX}/Ogg.Framework/Headers \
                 -I${PREFIX}/Vorbis.Framework/Headers
VORBIS_LDFLAGS = -framework Ogg -framework Vorbis

ARCH_LDFLAGS = -F/Users/ajs/workspace/Frameworks

arch/darwin/SDLMain.o: arch/darwin/SDLMain.m
	$(if ${V},,@echo "  CC      " $<)
	${CC} -MD ${CFLAGS} ${SDL_CFLAGS} -c $< -o $@

package: all
	${MV} ${core_target} ${core_target}.${REAL_ARCH}
	${MV} ${editor_target} ${editor_target}.${REAL_ARCH}
	${MV} ${network_target} ${network_target}.${REAL_ARCH}
	${MV} ${mzx} ${mzx}.${REAL_ARCH}
	${MV} ${mzxrun} ${mzxrun}.${REAL_ARCH}

clean:
	${RM} arch/darwin/SDLMain.o arch/darwin/SDLMain.d

package_clean: clean
	${RM} ${core_target}.${REAL_ARCH}
	${RM} ${editor_target}.${REAL_ARCH}
	${RM} ${network_target}.${REAL_ARCH}
	${RM} ${mzx}.${REAL_ARCH}
	${RM} ${mzxrun}.${REAL_ARCH}

lipo:
	@arch/darwin/lipo.sh

dist:
	@${MAKE} -j3 ARCH=i686 package
	@${MAKE} -j3 ARCH=i686 clean
	@${MAKE} -j3 ARCH=ppc package
	@${MAKE} -j3 ARCH=ppc clean
	@${MAKE} lipo

build := build/${SUBPLATFORM}/MegaZeux.app/Contents/Resources
build:
	${MKDIR} ${build}/../MacOS
	${MKDIR} ${build}/../Frameworks
	${CP} -R ../Frameworks/* ${build}/../Frameworks
	${CP} arch/darwin/MegaZeux.plist ${build}/../Info.plist
	${CP} contrib/icons/quantump.icns ${build}/MegaZeux.icns
	${RM} ${build}/*.debug ${build}/utils/*.debug
	${MV} ${build}/docs ${build}/../../..
	${MV} ${build}/${mzx} ${build}/../MacOS/MegaZeux
	${MV} ${build}/${mzxrun} ${build}/../MacOS/MZXRun
	${MV} ${build}/*.dylib ${build}/../MacOS
	${LN} -s MegaZeux.app/Contents/Resources/config.txt ${build}/../../..
	${MKDIR} -p ${build}/../../../MZXRun.app/Contents
	${CP} arch/darwin/MZXRun.plist \
		${build}/../../../MZXRun.app/Contents/Info.plist
	${LN} -s ../../MegaZeux.app/Contents/Frameworks \
		${build}/../../../MZXRun.app/Contents/Frameworks
	${LN} -s ../../MegaZeux.app/Contents/Resources \
		${build}/../../../MZXRun.app/Contents/Resources
	${LN} -s ../../MegaZeux.app/Contents/MacOS \
		${build}/../../../MZXRun.app/Contents/MacOS

archive: build
	@arch/darwin/dmg.sh ${TARGET}
