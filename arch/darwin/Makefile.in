#
# OS X makefile generics
#

DSOLDFLAGS = -dynamiclib
DSOPRE     = lib
DSOPOST    = .dylib
DSORPATH   =
DSOSONAME  = -install_name ${LIBDIR}/

STRIP   ?= strip

#
# darwin specific recipes.
# Enable 'make install' and 'make uninstall' for darwin builds.
#

ifeq (${SUBPLATFORM},darwin)

include arch/install.inc

# No platform-specific files to install
install-arch:
uninstall-arch:

endif

#
# darwin-dist specific recipes.
# These recipes are intended to produce portable Mac OS X .apps.
# This setup is extremely old and for Intel Macs has been superceded
# by the Xcode project folder (see: arch/xcode). However, this is still
# required to build PowerPC Mac .apps.
#

ifeq (${SUBPLATFORM},darwin-dist)

.PHONY: dist lipo package_clean

# Make dylib path the same as the executable path instead
DSOSONAME  = -install_name @executable_path/

CROSS_COMPILE_X86_CC  ?= i686-apple-darwin10-gcc-4.2.1
CROSS_COMPILE_X86_CXX ?= i686-apple-darwin10-g++-4.2.1
CROSS_COMPILE_PPC_CC  ?= powerpc-apple-darwin10-gcc-4.2.1
CROSS_COMPILE_PPC_CXX ?= powerpc-apple-darwin10-g++-4.2.1

ifeq (${ARCH},)
ARCH := i686
endif

ifeq (${ARCH},i686)
CC        := ${CROSS_COMPILE_X86_CC}  -mmacosx-version-min=10.6
CXX       := ${CROSS_COMPILE_X86_CXX} -mmacosx-version-min=10.6
REAL_ARCH := i686
else

ifeq (${ARCH},amd64)
CC        := ${CROSS_COMPILE_X86_CC}  -m64 -mmacosx-version-min=10.6
CXX       := ${CROSS_COMPILE_X86_CXX} -m64 -mmacosx-version-min=10.6
REAL_ARCH := amd64
else

ifeq (${ARCH},ppc)
CC        := ${CROSS_COMPILE_PPC_CC}  -mmacosx-version-min=10.4
CXX       := ${CROSS_COMPILE_PPC_CXX} -mmacosx-version-min=10.4
REAL_ARCH := ppc
else

ifeq (${ARCH},ppc64)
CC        := ${CROSS_COMPILE_PPC_CC}  -m64 -mmacosx-version-min=10.4
CXX       := ${CROSS_COMPILE_PPC_CXX} -m64 -mmacosx-version-min=10.4
REAL_ARCH := ppc64
else

REAL_ARCH := $(error Invalid architecture selection)
endif
endif
endif
endif

arch/darwin/SDLMain.o: arch/darwin/SDLMain.m
	$(if ${V},,@echo "  CC      " $<)
	${CC} -MD ${CFLAGS} ${SDL_CFLAGS} -c $< -o $@

package: all
	${MV} ${core_target} ${core_target}.${REAL_ARCH}
	${MV} ${editor_target} ${editor_target}.${REAL_ARCH}
	${MV} ${mzx} ${mzx}.${REAL_ARCH}
	${MV} ${mzxrun} ${mzxrun}.${REAL_ARCH}

clean:
	${RM} arch/darwin/SDLMain.o arch/darwin/SDLMain.d

package_clean: clean
	${RM} ${core_target}.${REAL_ARCH}
	${RM} ${editor_target}.${REAL_ARCH}
	${RM} ${network_target}.${REAL_ARCH}
	${RM} ${mzx}.${REAL_ARCH}
	${RM} ${mzxrun}.${REAL_ARCH}

lipo:
	@arch/darwin/lipo.sh

dist:
	@${CP} platform.inc platform.inc.orig
	@sed 's,blah,${HOME}/workspace/build-i686,g' \
	     platform.inc.orig >platform.inc
	@${MAKE} ARCH=i686 package
	@${MAKE} ARCH=i686 clean
	@sed 's,blah,${HOME}/workspace/build-powerpc,g' \
	     platform.inc.orig >platform.inc
	@${MAKE} ARCH=ppc package
	@${MAKE} ARCH=ppc clean
	@${MAKE} lipo

build := build/${SUBPLATFORM}/MegaZeux.app/Contents/Resources
build:
	${MKDIR} ${build}/../MacOS
	${CP} arch/darwin/MegaZeux.plist ${build}/../Info.plist
	${CP} contrib/icons/quantump.icns ${build}/MegaZeux.icns
	${RM} ${build}/*.debug ${build}/utils/*.debug
	${MV} ${build}/docs ${build}/../../..
	${MV} ${build}/LICENSE ${build}/../../../docs/
	${MV} ${build}/${mzx} ${build}/../MacOS/MegaZeux
	${MV} ${build}/${mzxrun} ${build}/../MacOS/MZXRun
	${MV} ${build}/*.dylib ${build}/../MacOS
	${LN} -s MegaZeux.app/Contents/Resources/config.txt ${build}/../../..
	${MKDIR} -p ${build}/../../../MZXRun.app/Contents
	${CP} arch/darwin/MZXRun.plist \
		${build}/../../../MZXRun.app/Contents/Info.plist
	${LN} -s ../../MegaZeux.app/Contents/Resources \
		${build}/../../../MZXRun.app/Contents/Resources
	${LN} -s ../../MegaZeux.app/Contents/MacOS \
		${build}/../../../MZXRun.app/Contents/MacOS

archive: build
	@arch/darwin/dmg.sh ${TARGET}

endif # darwin-dist
